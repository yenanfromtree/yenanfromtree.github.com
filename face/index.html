<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <script src="js/mui.min.js"></script>
    <link href="css/mui.min.css" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css" href="css/main.css"/>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="js/tracking.js"></script>
    <script src="js/data/face-min.js"></script>
    <script src="js/data/eye-min.js"></script>
    <script src="js/data/mouth-min.js"></script>
    <script type="text/javascript" charset="utf-8">
      	mui.init();
    </script>
</head>
<body>
	<audio src=" " id="play" autoplay="autoplay"></audio>
    <!-- <div class="rotate"></div> -->
    <div class="topbar">唱吧麦颂（三元桥店）刷脸抽奖活动</div>
    <div class="box">
        <div class="text">靠脸吃饭，赢免单</div>
    </div>

    <div id="imgbox">
        <!-- <img src="./scan.gif" alt="" class="scan"> -->
    </div>
    <div class="jp">
        <p class="jpnr">爆米花一份！百威啤酒12瓶！</p>
        <p class="num">编号：00953723</p>
    </div>
    <div class="btn">
        <!-- <input type="file" multiple accept="capture=camera" onchange="imagePreview(this)"> -->
        <a href="javascript:;" class="a-upload" id="btn">
            <input type="file" accept="capture=camera" id="input" name="">开始刷脸抽奖
        </a>
    </div>
</body>
<script>
	window.onload = function () {
        var data=[
            '么么哒，毛绒小熊送给你！',
            '送你一条充电线，以后不怕没电了',
            '哇！本次消费免单！',
            '给你个大果盘，补充vc吧！',
            '你的人生道路缺一个手电筒照亮',
            '额。。没有找到和你的气质相符的奖品',
            '送你一个杯子，希望你能保存一辈子',
        ]
        function sbimg() {
            var img = document.getElementById('pic');
            var tracker = new tracking.ObjectTracker(['face']);
            tracker.setStepSize(1.7);
            tracking.track('#pic', tracker);
            tracker.on('track', function (event) {

                event.data.forEach(function (rect) {
                    window.plot(rect.x, rect.y, rect.width, rect.height);
                });
                if (event.data.length == 0) {
                    console.log('未识别到人脸', event.data)
                    $('#play').attr('src', './MP3/nopople.mp3');
                } else if (event.data.length >= 2) {
                    console.log('请不相干的人走开', event.data)
                    $('#play').attr('src', './MP3/morepople.mp3');
                } else {
                    console.log('识别成功！', event.data)
                    $('#play').attr('src', './MP3/isok.mp3');
                    $('.jp').addClass('active');
                    $('.num').html('编号：'+Date.parse(new Date()));
                    $('.jpnr').html(data[Math.floor(Math.random()*6)])
                }
            });

            window.plot = function (x, y, w, h) {
                var rect = document.createElement('div');
                document.querySelector('#imgbox').appendChild(rect);
                rect.classList.add('rect');
                rect.style.width = w + 'px';
                rect.style.height = h + 'px';
                rect.style.left = (img.offsetLeft + x) + 'px';
                rect.style.top = (img.offsetTop + y) + 'px';


            };
        }
        $('#input').change(function () {
            imagePreview($('#input')[0])
        })
        function imagePreview(input) {
            var files = input.files;
            // 假设 "preview" 是将要展示图片的 div
            var preview = document.getElementById('imgbox');
            preview.innerHTML = '';
            $('.jp').removeClass('active');
            for (var i = 0; i < files.length; i++) {//预览新添加的图片
                var file = files[i];
                var imageType = /^image\//;
                var img = document.createElement("img");
                img.classList.add("obj");
                img.id = 'pic';
                img.file = file;
                preview.appendChild(img);
                var reader = new FileReader();
                reader.onload = (function (aImg) {
                    return function (e) {
                        console.log(aImg)
                        aImg.width = 180
                        aImg.height = 320
                        aImg.src = e.target.result;
                        // console.log(e.target.result);
                        $('#play').attr('src', './MP3/shibie.mp3');
                        $('#imgbox').append('<img src="./scan.gif" alt="" class="scan">');
                        setTimeout(function () {
                            $('.scan').remove();
                            sbimg();

                        }, 3000)

                    };
                })(img);
                reader.readAsDataURL(file);

            }
            $('#imgbox img').attr('id', 'pic');
        }

        $('#btn').click(function () {
            $('#play').attr('src', './MP3/check.mp3')
        })
    }
</script>
</html>